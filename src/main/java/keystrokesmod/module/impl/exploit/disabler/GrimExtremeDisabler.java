package keystrokesmod.module.impl.exploit.disabler;

import keystrokesmod.event.SendPacketEvent;
import keystrokesmod.module.impl.exploit.Disabler;
import keystrokesmod.module.setting.impl.SliderSetting;
import keystrokesmod.module.setting.impl.SubMode;
import net.minecraft.network.Packet;
import net.minecraft.network.play.client.C03PacketPlayer;
import net.minecraftforge.fml.common.eventhandler.EventPriority;
import net.minecraftforge.fml.common.eventhandler.SubscribeEvent;
import org.jetbrains.annotations.NotNull;

/**
 * Port of Latest-Eclipse Grim ExtremePacket disabler:
 *
 * object ExtremePacket : Grim() {
 *     init {
 *         task { event: PacketEvent -> val packet = event.packet
 *             if (packet is C03PacketPlayer) {
 *                 packet.x += 999999
 *                 packet.y += -999999
 *                 packet.z += 999999
 *             }
 *         }.runIf { runnable && grim_extremePacket && WorldTimer.tickTick > 3 }
 *     }
 * }
 *
 * This Java port adds configurable offsets for X/Y/Z to allow tweaking.
 */
public class GrimExtremeDisabler extends SubMode<Disabler> {

    private final SliderSetting offsetX;
    private final SliderSetting offsetY;
    private final SliderSetting offsetZ;

    public GrimExtremeDisabler(String name, @NotNull Disabler parent) {
        super(name, parent);
        this.registerSetting(offsetX = new SliderSetting("X offset", 999999, -1_000_000, 1_000_000, 1));
        this.registerSetting(offsetY = new SliderSetting("Y offset", -999999, -1_000_000, 1_000_000, 1));
        this.registerSetting(offsetZ = new SliderSetting("Z offset", 999999, -1_000_000, 1_000_000, 1));
    }

    @SubscribeEvent(priority = EventPriority.LOWEST)
    public void onSendPacket(@NotNull SendPacketEvent event) {
        Packet<?> packet = event.getPacket();

        // Only touch position packets; leave pure look/onGround packets alone
        if (packet instanceof C03PacketPlayer.C04PacketPlayerPosition) {
            C03PacketPlayer.C04PacketPlayerPosition pos = (C03PacketPlayer.C04PacketPlayerPosition) packet;

            double x = pos.getPositionX() + offsetX.getInput();
            double y = pos.getPositionY() + offsetY.getInput();
            double z = pos.getPositionZ() + offsetZ.getInput();

            event.setPacket(new C03PacketPlayer.C04PacketPlayerPosition(
                    x, y, z,
                    pos.isOnGround()
            ));
        } else if (packet instanceof C03PacketPlayer.C06PacketPlayerPosLook) {
            C03PacketPlayer.C06PacketPlayerPosLook posLook = (C03PacketPlayer.C06PacketPlayerPosLook) packet;

            double x = posLook.getPositionX() + offsetX.getInput();
            double y = posLook.getPositionY() + offsetY.getInput();
            double z = posLook.getPositionZ() + offsetZ.getInput();

            event.setPacket(new C03PacketPlayer.C06PacketPlayerPosLook(
                    x, y, z,
                    posLook.getYaw(), posLook.getPitch(),
                    posLook.isOnGround()
            ));
        }
    }
}


